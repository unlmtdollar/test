<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Nuur Claim</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg: #0b0f14;
      --panel: #0f1720;
      --muted: #9aa5b1;
      --text-muted: #e6eef8;

      --color-primary: #d4af37;
      --color-accent: #14b8a6;
      --color-warn: #fb6f6f;
      --color-strong: #5b21b6;
      --color-success: #10b981;

      --glass: rgba(255,255,255,0.03);
      --card-radius:14px;
      --shadow: 0 10px 30px rgba(2,6,23,0.7);
      --maxw:1100px;

      --pad: 14px;
      --radius: 12px;
    }

    body[data-theme="light"] {
      --bg: #f4f6f9;
      --panel: #ffffff;
      --muted: #334155;
      --text-muted: #0b1220;

      --color-primary: #b8860b;
      --color-accent: #0f766e;
      --color-warn: #fb923c;
      --color-strong: #4c1d95;
      --color-success: #059669;

      --shadow: 0 8px 20px rgba(11,14,19,0.04);
    }

    html, body {
      transition: background-color 360ms ease, color 360ms ease;
      background: linear-gradient(180deg, var(--bg) 0%, rgba(0,0,0,0.02) 100%);
      color: var(--text-muted);
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .sidebar, .main, .panel, .card, .modal, .btn {
      transition: background-color 360ms ease, color 360ms ease, box-shadow 360ms ease, border-color 360ms ease;
    }

    .logo {
      transition: background 420ms ease, box-shadow 420ms ease;
    }

    .progress-bar {
      transition: width 600ms ease, background 360ms ease;
    }

    .app { width: 100%; max-width: var(--maxw); margin: 18px auto; display: grid; grid-template-columns: 280px 1fr; gap: 18px; align-items: start; padding: 12px; }

    .sidebar { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: var(--card-radius); padding: 16px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.06); min-height:520px; display:flex; flex-direction:column; gap:12px; }
    .brand { display:flex; gap:12px; align-items:center; }
    .brand .logo { width:56px; height:56px; border-radius: 10px; overflow:hidden; background: linear-gradient(135deg, var(--color-primary), var(--color-strong)); display:flex; align-items:center; justify-content:center; box-shadow: 0 8px 26px rgba(0,0,0,0.12); flex-shrink:0; }
    .brand .logo img { width:100%; height:100%; object-fit:cover; display:block; }
    .brand h1 { margin:0; font-size:18px; color: var(--color-primary); font-weight:700; }
    .brand p { margin:0; font-size:12px; color:var(--muted); }

    .controls { display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:10px 12px; border-radius:10px; border: none; cursor:pointer; font-weight:700; transition: transform .12s ease; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(90deg, var(--color-accent), var(--color-success)); color: #fff; box-shadow: 0 8px 22px rgba(0,0,0,0.12); }
    .btn-ghost { background: transparent; border: 1px solid rgba(0,0,0,0.06); color: var(--muted); padding: 10px; border-radius: 10px; }
    .btn-theme { background: transparent; border: 1px solid rgba(0,0,0,0.06); color: var(--muted); padding: 10px; border-radius: 10px; }

    .small { font-size:13px; color: var(--muted); }

    .card { background: var(--panel); border-radius: var(--radius); padding: 12px; border:1px solid rgba(0,0,0,0.04); box-shadow: var(--shadow); }

    .main { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border-radius: var(--card-radius); padding: 18px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.06); min-height:520px; display:flex; flex-direction:column; gap:14px; }

    .top-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .muted { color:var(--muted); font-size:13px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }

    .panel { background: var(--panel); border-radius: 12px; padding:12px; border:1px solid rgba(0,0,0,0.04); }
    .panel h3 { margin: 0 0 8px 0; color: var(--muted); font-size:13px; }
    .big-value { font-size:20px; font-weight:800; color: var(--color-primary); }

    .progress-wrap { height:12px; background: rgba(255,255,255,0.03); border-radius: 10px; overflow:hidden; margin-top:10px; }
    .progress-bar { height:100%; width:0%; background: linear-gradient(90deg, var(--color-strong), var(--color-warn)); }

    .claim-area { display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .claim-amount { font-size:18px; font-weight:800; color: var(--color-warn); }

    .countdown { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .unit { background: rgba(255,255,255,0.03); padding:8px 10px; border-radius:8px; min-width:62px; text-align:center; }
    .num { font-weight:800; font-size:16px; color: var(--color-accent); }
    .lbl { font-size:11px; color:var(--muted); text-transform:uppercase; }

    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }

    .modal-backdrop { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); z-index:80; }
    .modal-backdrop.show { display:flex; }
    .modal { width: min(96%, 880px); background: var(--panel); border-radius: 12px; padding:16px; border:1px solid rgba(0,0,0,0.06); }

    .user-type-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .whale-badge {
      background: var(--color-strong);
      color: white;
    }
    .small-badge {
      background: var(--color-success);
      color: white;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      background: var(--panel);
      color: var(--text-muted);
      font-size: 14px;
      box-sizing: border-box;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .status-value {
      font-weight: 700;
      color: var(--color-primary);
    }

    /* responsive */
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; padding:8px; gap:10px; }
      .sidebar { order: 0; display:flex; flex-direction:column; align-items:stretch; gap:10px; padding:10px; min-height: auto; }
      .brand { justify-content: center; text-align: center; }
      .brand .logo { width: 48px; height: 48px; }
      .controls { flex-direction:row; gap:8px; margin-left:0; justify-content: center; }
      .main { order:1; padding:12px; }
      .grid-2 { grid-template-columns: 1fr; }
      .card, .panel { padding:12px; }
      .btn { padding:10px; font-size:14px; }
      .claim-area { justify-content: space-between; }
      .unit { min-width:48px; padding:8px; }
      .top-row { flex-direction: column; align-items: flex-start; }
    }

    @media (max-width:600px){
      .app { padding: 6px; }
      .sidebar { padding: 10px; }
      .main { padding: 10px; }
      .brand { flex-direction: column; text-align: center; }
      .brand h1 { font-size: 16px; }
      .controls { flex-wrap: wrap; justify-content: center; }
      .btn { flex: 1; min-width: 120px; }
      .countdown { justify-content: center; }
      .unit { min-width: 40px; padding: 6px; }
      .num { font-size: 14px; }
      .lbl { font-size: 10px; }
      .big-value { font-size: 18px; }
      .claim-amount { font-size: 16px; }
    }

    #themeToggle { display: none; }
  </style>
</head>
<body data-theme="dark">
  <div class="app" role="application" aria-label="Nuur claim app">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="sidebar">
      <div class="brand" aria-hidden="false">
        <div class="logo" title="Nuur Logo">
          <img id="logoImg" src="logo.jpg" alt="Nuur Logo" />
        </div>
        <div style="flex:1">
          <h1>Nuur Claim</h1>
          <p class="small">Token migration & claims</p>
        </div>
      </div>

      <div class="controls" id="sidebarControls" role="toolbar" aria-label="controls">
        <button id="connectBtn" class="btn btn-primary" aria-live="polite">Connect Wallet</button>
        <button id="themeToggle" class="btn btn-theme" title="Toggle light / dark">
          <i class="fas fa-moon"></i> Mode
        </button>
      </div>

      <div class="card" id="accountBox" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted small">Connected</div>
            <div id="addrShort" style="font-weight:700">0x--</div>
          </div>
          <div>
            <div class="muted small">Network</div>
            <div id="chainLabel" style="font-weight:700">Sidra Chain</div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; justify-content:space-between; gap:8px;">
          <div>
            <div class="muted small">NUUR</div>
            <div id="nuurBal" style="font-weight:800">0.00</div>
          </div>
          <div>
            <div class="muted small">SDA</div>
            <div id="sdaBal" style="font-weight:800">0.00</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="muted small">KYC</div>
          <div style="margin-top:6px"><span id="kycDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--color-warn);margin-right:8px"></span><span id="kycText">Not verified</span></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="refreshBtnSmall" class="btn btn-ghost">Refresh</button>
          <button id="adminBtnSmall" class="btn btn-ghost" style="display:none">Admin</button>
        </div>
      </div>

      <div class="small" style="margin-top:auto">
        <div><strong>Notes</strong></div>
        <div style="margin-top:6px" class="muted small">Please complete KYC verification and take a snapshot before claiming.</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="mainArea" aria-live="polite">
      <div class="top-row">
        <div>
          <h2 style="margin:0">Dashboard</h2>
          <div class="muted small" style="margin-top:6px">Overview of your claim status</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <a id="contractLink" class="muted small" href="#" target="_blank" rel="noopener">View on explorer</a>
          <button id="openAdmin" class="btn btn-ghost" style="display:none">Admin</button>
          <button id="disconnectBtn" class="btn btn-ghost" style="display:none">Disconnect</button>
        </div>
      </div>

      <div class="grid-2">
        <div class="panel">
          <h3>Allocation</h3>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="muted small">Snapshot Balance</div>
              <div id="snapshotBalance" class="big-value" style="margin-top:8px">0 NUUR</div>
            </div>
            <div style="text-align:right">
              <div class="muted small">Claimed</div>
              <div id="claimed" style="font-weight:800; margin-top:8px">0 NUUR</div>
            </div>
          </div>

          <div class="progress-wrap">
            <div class="progress-bar" id="progressBar"></div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="muted small">Months passed</div>
            <div id="monthsPassed" style="font-weight:800">0 / 12</div>
          </div>

          <div style="margin-top:12px">
            <div class="muted small">User Type</div>
            <div id="userType" style="margin-top:6px"></div>
          </div>

          <div class="claim-area">
            <div>
              <div class="muted small">Claimable now</div>
              <div class="claim-amount" id="claimableDisplay">0 NUUR</div>
            </div>

            <div style="margin-left:auto">
              <button id="claimBtn" class="btn btn-primary" disabled>Claim</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="muted small">Minimum claim amount</div>
            <input type="number" id="minAmountInput" class="form-input" placeholder="0.0" step="0.1" style="margin-top:6px" />
          </div>

          <div class="countdown" id="countdown">
            <div class="unit"><div class="num" id="cdDays">--</div><div class="lbl">Days</div></div>
            <div class="unit"><div class="num" id="cdHours">--</div><div class="lbl">Hours</div></div>
            <div class="unit"><div class="num" id="cdMins">--</div><div class="lbl">Mins</div></div>
            <div class="unit"><div class="num" id="cdSecs">--</div><div class="lbl">Secs</div></div>
          </div>
        </div>

        <div class="panel">
          <h3>Actions</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="takeSnapshotBtn" class="btn btn-primary">Take Snapshot</button>
            <button id="refreshBtnLarge" class="btn btn-ghost">Refresh</button>
          </div>

          <div style="margin-top:12px">
            <div class="muted small">Snapshot Status</div>
            <div style="margin-top:8px" id="snapshotStatus">Not taken</div>
          </div>

          <div style="margin-top:12px">
            <div class="muted small">Monthly Rate</div>
            <div style="margin-top:8px" id="monthlyRate">0%</div>
          </div>

          <div style="margin-top:12px">
            <div class="status-item">
              <div class="muted small">Vesting:</div>
              <div id="vestingStatus" class="status-value">Not started</div>
            </div>
            <div class="status-item">
              <div class="muted small">Paused:</div>
              <div id="pausedStatus" class="status-value">No</div>
            </div>
            <div class="status-item">
              <div class="muted small">Claim Cooldown:</div>
              <div id="cooldownStatus" class="status-value">Ready</div>
            </div>
            <div class="status-item">
              <div class="muted small">Contract Balance:</div>
              <div id="contractBalanceDisplay" class="status-value">0 NUUR</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ADMIN MODAL -->
  <div id="adminModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Admin Controls</h3>
        <div style="display:flex;gap:8px">
          <button id="closeAdmin" class="btn btn-ghost">Close</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <label class="muted small">Set single KYC</label>
          <input id="adminKycAddr" class="form-input" placeholder="0x..." />
          <select id="adminKycStatus" class="form-input" style="margin-top:8px;">
            <option value="true">Verified</option>
            <option value="false">Not verified</option>
          </select>
          <div style="margin-top:8px"><button id="adminSetKyc" class="btn btn-primary">Set KYC</button></div>

          <div style="height:8px"></div>

          <label class="muted small">Batch KYC (addresses comma/newline separated)</label>
          <textarea id="adminKycBatchAddrs" class="form-input" style="min-height:80px;"></textarea>
          <select id="adminKycBatchStatus" class="form-input" style="margin-top:8px;">
            <option value="true">All Verified</option>
            <option value="false">All Not Verified</option>
          </select>
          <div style="margin-top:8px">
            <button id="adminScheduleKycBatch" class="btn btn-primary">Schedule Batch KYC</button>
          </div>
        </div>

        <div>
          <label class="muted small">Contract Funds</label>
          <div style="margin-top:8px">
            <div class="muted small">Contract Balance:</div>
            <div id="adminContractBalance" style="font-weight:800; margin-top:4px">0 NUUR</div>
          </div>

          <div style="margin-top:12px">
            <label class="muted small">Deposit Funds</label>
            <input id="depositAmount" class="form-input" placeholder="Amount in NUUR" />
            <div style="margin-top:8px"><button id="adminDeposit" class="btn btn-primary">Deposit</button></div>
          </div>

          <div style="margin-top:12px">
            <label class="muted small">Whale Threshold</label>
            <div id="currentWhaleThreshold" style="font-weight:800; margin-top:4px">0 NUUR</div>
            <input id="newWhaleThreshold" class="form-input" placeholder="New threshold" style="margin-top:8px" />
            <div style="margin-top:8px"><button id="adminScheduleThreshold" class="btn btn-primary">Schedule Threshold Update</button></div>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <!-- Pending Operations -->
      <div style="margin-top:16px; border-top: 1px solid rgba(0,0,0,0.1); padding-top:16px;">
        <h4>Pending Operations</h4>
        <div id="pendingOperations" style="margin-top:8px">
          <div class="muted small">No pending operations</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="adminStart" class="btn btn-primary">Start Vesting</button>
        <button id="adminPause" class="btn btn-ghost">Pause</button>
        <button id="adminUnpause" class="btn btn-ghost">Unpause</button>
      </div>
    </div>
  </div>

  <div id="toast" style="position:fixed; right:18px; top:18px; display:none; background:var(--panel); color:var(--muted); padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); z-index:90;"></div>

<script>
(function(){
  /* ------------------- Config -------------------- */
  const CONTRACT_ADDR = "YOUR_CONTRACT_ADDRESS_HERE";
  const NUUR_TOKEN = "YOUR_NUUR_TOKEN_ADDRESS_HERE";
  const SIDRA_CHAIN = { chainId: "0x17CAD", blockExplorerUrls:["https://ledger.sidrachain.com"] };
  const EXPLORER = (SIDRA_CHAIN.blockExplorerUrls && SIDRA_CHAIN.blockExplorerUrls[0]) ? SIDRA_CHAIN.blockExplorerUrls[0].replace(/\/$/,'') : '';

  const VESTING_ABI = [
    // Core state variables
    "function owner() view returns (address)",
    "function newToken() view returns (address)",
    "function oldToken() view returns (address)",
    "function whaleThreshold() view returns (uint256)",
    "function vestingStartTime() view returns (uint256)",
    "function contractCreationTime() view returns (uint256)",
    "function vestingStarted() view returns (bool)",
    "function paused() view returns (bool)",
    
    // User functions
    "function kycVerified(address) view returns (bool)",
    "function claimInfo(address) view returns (uint256 totalAmount, uint256 claimedAmount, uint256 snapshotBalance, bool snapshotTaken, bool exists)",
    "function lastClaimTime(address) view returns (uint256)",
    "function kycLastUpdate(address) view returns (uint256)",
    
    // View functions
    "function getUserTotalPurchase(address) view returns (uint256)",
    "function getClaimableAmount(address) view returns (uint256)",
    "function getUserClaimInfo(address) view returns (uint256 totalAmount, uint256 claimedAmount, uint256 snapshotBalance, bool snapshotTaken, bool isWhaleHolder, uint256 monthlyPercent)",
    "function getContractBalance() view returns (uint256)",
    "function canClaim(address) view returns (bool)",
    "function getCooldownRemaining(address) view returns (uint256)",
    "function getKYCUpdateCooldownRemaining(address) view returns (uint256)",
    
    // User actions
    "function takeSnapshot()",
    "function claim(uint256 minAmount)",
    
    // Admin functions - basic
    "function startVesting()",
    "function pause()",
    "function unpause()",
    "function setKYC(address user, bool status)",
    "function depositFunds(uint256 amount)",
    
    // Admin functions - timelocked
    "function scheduleKYCBatchUpdate(address[] users, bool status)",
    "function executeKYCBatchUpdate()",
    "function scheduleWhaleThresholdUpdate(uint256 newThreshold)",
    "function executeWhaleThresholdUpdate()",
    
    // Admin functions - view pending
    "function getPendingKYCBatch() view returns (address[] memory users, bool status, uint256 scheduledTime, bool executed, bool canExecute)",
    "function getPendingWhaleThresholdUpdate() view returns (uint256 newThreshold, uint256 scheduledTime, bool executed, bool canExecute)",
    
    // Emergency functions
    "function addRecoverableToken(address token)",
    "function removeRecoverableToken(address token)",
    "function emergencyWithdraw(address tokenAddress, uint256 amount)",
    "function emergencyWithdrawAll(address tokenAddress)"
  ];

  /* ------------------- DOM -------------------- */
  const connectBtn = document.getElementById('connectBtn');
  const themeToggle = document.getElementById('themeToggle');

  const ctaAccountBox = document.getElementById('accountBox');
  const addrShort = document.getElementById('addrShort');
  const chainLabel = document.getElementById('chainLabel');
  const nuurBal = document.getElementById('nuurBal');
  const sdaBal = document.getElementById('sdaBal');
  const kycDot = document.getElementById('kycDot');
  const kycText = document.getElementById('kycText');
  const refreshBtnSmall = document.getElementById('refreshBtnSmall');
  const refreshBtnLarge = document.getElementById('refreshBtnLarge');
  const takeSnapshotBtn = document.getElementById('takeSnapshotBtn');
  const adminBtnSmall = document.getElementById('adminBtnSmall');
  const openAdmin = document.getElementById('openAdmin');
  const disconnectBtn = document.getElementById('disconnectBtn');

  const snapshotBalance = document.getElementById('snapshotBalance');
  const claimedEl = document.getElementById('claimed');
  const claimableDisplay = document.getElementById('claimableDisplay');
  const progressBar = document.getElementById('progressBar');
  const monthsPassedEl = document.getElementById('monthsPassed');
  const userType = document.getElementById('userType');
  const snapshotStatus = document.getElementById('snapshotStatus');
  const monthlyRate = document.getElementById('monthlyRate');
  const minAmountInput = document.getElementById('minAmountInput');
  const cdDays = document.getElementById('cdDays');
  const cdHours = document.getElementById('cdHours');
  const cdMins = document.getElementById('cdMins');
  const cdSecs = document.getElementById('cdSecs');
  const vestingStatus = document.getElementById('vestingStatus');
  const pausedStatus = document.getElementById('pausedStatus');
  const cooldownStatus = document.getElementById('cooldownStatus');
  const contractBalanceDisplay = document.getElementById('contractBalanceDisplay');
  const claimBtn = document.getElementById('claimBtn');
  const contractLink = document.getElementById('contractLink');

  // admin modal elements
  const adminModal = document.getElementById('adminModal');
  const closeAdmin = document.getElementById('closeAdmin');
  const adminKycAddr = document.getElementById('adminKycAddr');
  const adminKycStatus = document.getElementById('adminKycStatus');
  const adminSetKyc = document.getElementById('adminSetKyc');
  const adminKycBatchAddrs = document.getElementById('adminKycBatchAddrs');
  const adminKycBatchStatus = document.getElementById('adminKycBatchStatus');
  const adminScheduleKycBatch = document.getElementById('adminScheduleKycBatch');
  const adminContractBalance = document.getElementById('adminContractBalance');
  const depositAmount = document.getElementById('depositAmount');
  const adminDeposit = document.getElementById('adminDeposit');
  const currentWhaleThreshold = document.getElementById('currentWhaleThreshold');
  const newWhaleThreshold = document.getElementById('newWhaleThreshold');
  const adminScheduleThreshold = document.getElementById('adminScheduleThreshold');
  const pendingOperations = document.getElementById('pendingOperations');
  const adminStart = document.getElementById('adminStart');
  const adminPause = document.getElementById('adminPause');
  const adminUnpause = document.getElementById('adminUnpause');

  const toastEl = document.getElementById('toast');

  /* ------------------- State -------------------- */
  let provider = null;
  let signer = null;
  let account = null;
  let contract = null;
  let tokenContract = null;
  let decimals = 18;
  let vestingStartTimeSec = 0;
  let nextVestingTimeMs = null;
  let lastClaimable = ethers.BigNumber.from(0);
  let isOwner = false;
  const POLL_INTERVAL = 15000;

  /* ------------------- Utilities -------------------- */
  function toastShow(msg, kind = 'info', link=null){
    toastEl.style.display = 'block';
    toastEl.textContent = msg;
    if(link){
      const a = document.createElement('a');
      a.href = link; a.target = '_blank'; a.textContent = ' View';
      a.style.marginLeft = '8px'; a.style.color = 'var(--color-primary)';
      toastEl.appendChild(a);
    }
    clearTimeout(toastShow._t); toastShow._t = setTimeout(()=>{ toastEl.style.display = 'none'; toastEl.textContent = ''; }, 3800);
  }
  
  function short(addr){ return addr ? `${addr.slice(0,6)}‚Ä¶${addr.slice(-4)}` : '0x--'; }
  
  function formatSdaBalance(balance) {
    const num = parseFloat(ethers.utils.formatEther(balance));
    return num.toFixed(2);
  }

  function formatTokenAmount(amount, decimals = 18) {
    return parseFloat(ethers.utils.formatUnits(amount, decimals)).toFixed(4);
  }

  /* ----------------- Theme handling ------------------ */
  const body = document.body;
  function applyStoredTheme(){
    const theme = localStorage.getItem('nuur:theme') || 'dark';
    body.setAttribute('data-theme', theme === 'light' ? 'light' : 'dark');
    updateThemeIcon(theme);
  }
  
  function updateThemeIcon(theme) {
    const themeIcon = themeToggle.querySelector('i');
    if (theme === 'light') {
      themeIcon.className = 'fas fa-sun';
    } else {
      themeIcon.className = 'fas fa-moon';
    }
  }
  
  applyStoredTheme();

  function showThemeToggle() {
    const t = document.getElementById('themeToggle');
    if (t) t.style.display = 'inline-block';
  }

  if (themeToggle) {
    themeToggle.addEventListener('click', ()=>{
      const current = body.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
      const next = current === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', next);
      localStorage.setItem('nuur:theme', next);
      updateThemeIcon(next);
      toastShow(`Switched to ${next} theme`);
    });
  }

  /* ---------------- Wallet & Contract logic ---------------- */
  async function connectWallet(){
    if(!window.ethereum){ toastShow('Please install MetaMask or compatible wallet','error'); return; }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    try {
      await provider.send('eth_requestAccounts',[]);
      signer = provider.getSigner();
      account = await signer.getAddress();
      contract = new ethers.Contract(CONTRACT_ADDR, VESTING_ABI, signer);
      tokenContract = new ethers.Contract(NUUR_TOKEN, [
        "function balanceOf(address) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function transferFrom(address, address, uint256) returns (bool)"
      ], signer);

      // UI updates
      if (connectBtn) connectBtn.style.display = 'none';
      if (ctaAccountBox) ctaAccountBox.style.display = 'block';
      if (openAdmin) openAdmin.style.display = 'none';
      if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
      if (addrShort) addrShort.textContent = short(account);
      try{ decimals = await tokenContract.decimals(); } catch(e){ decimals = 18; }
      if (contractLink) contractLink.href = EXPLORER ? `${EXPLORER}/address/${CONTRACT_ADDR}` : '#';

      showThemeToggle();
      await loadAll();
      startPoll();
    } catch (e){
      console.error(e);
      toastShow('Wallet connection failed', 'error');
    }
  }

  async function disconnectWallet(){
    account = null; signer = null; provider = null; contract = null; tokenContract = null;
    if (connectBtn) connectBtn.style.display = 'inline-block';
    if (ctaAccountBox) ctaAccountBox.style.display = 'none';
    if (openAdmin) openAdmin.style.display = 'none';
    if (disconnectBtn) disconnectBtn.style.display = 'none';
    if (themeToggle) themeToggle.style.display = 'none';
    toastShow('Disconnected');
  }

  async function loadAll(){
    if(!contract || !account) return;
    try {
      const [bNu, bSda] = await Promise.all([ 
        tokenContract.balanceOf(account), 
        provider.getBalance(account) 
      ]);
      if (nuurBal) nuurBal.textContent = formatTokenAmount(bNu, decimals);
      if (sdaBal) sdaBal.textContent = formatSdaBalance(bSda);

      const k = await contract.kycVerified(account);
      if (kycText) kycText.textContent = k ? 'Verified' : 'Not verified';
      if (kycDot) kycDot.style.background = k ? 'var(--color-success)' : 'var(--color-warn)';

      const [vStarted, paused, vestStartBN, contractBal, whaleThresh] = await Promise.all([ 
        contract.vestingStarted(), 
        contract.paused(), 
        contract.vestingStartTime(),
        contract.getContractBalance(),
        contract.whaleThreshold()
      ]);
      vestingStartTimeSec = vestStartBN.toNumber();
      if (vestingStatus) vestingStatus.textContent = vStarted ? 'Active' : 'Not started';
      if (pausedStatus) pausedStatus.textContent = paused ? 'Yes' : 'No';
      if (contractBalanceDisplay) contractBalanceDisplay.textContent = `${formatTokenAmount(contractBal, decimals)} NUUR`;
      if (currentWhaleThreshold) currentWhaleThreshold.textContent = `${formatTokenAmount(whaleThresh, decimals)} NUUR`;

      // Get user claim info
      const claimInfo = await contract.getUserClaimInfo(account);
      const [totalAmount, claimedAmount, snapshotBal, snapshotTaken, isWhale, monthlyPercent] = claimInfo;
      
      if (snapshotBalance) snapshotBalance.textContent = `${formatTokenAmount(snapshotBal, decimals)} NUUR`;
      if (claimedEl) claimedEl.textContent = `${formatTokenAmount(claimedAmount, decimals)} NUUR`;
      
      const claimable = await contract.getClaimableAmount(account);
      if (claimableDisplay) claimableDisplay.textContent = `${formatTokenAmount(claimable, decimals)} NUUR`;
      lastClaimable = claimable;

      // Update user type and monthly rate
      if (userType) {
        if (isWhale) {
          userType.innerHTML = '<span class="user-type-badge whale-badge">üêã Whale (10%/month)</span>';
        } else {
          userType.innerHTML = '<span class="user-type-badge small-badge">üë§ Small Holder (20%/month)</span>';
        }
      }
      
      if (monthlyRate) monthlyRate.textContent = `${monthlyPercent.toString()}%`;

      // Update snapshot status
      if (snapshotStatus) {
        snapshotStatus.textContent = snapshotTaken ? 'Taken' : 'Not taken';
        snapshotStatus.style.color = snapshotTaken ? 'var(--color-success)' : 'var(--color-warn)';
      }

      // Enable/disable snapshot button
      if (takeSnapshotBtn) {
        takeSnapshotBtn.disabled = !k || snapshotTaken;
      }

      // Check cooldown status
      const cooldownRemaining = await contract.getCooldownRemaining(account);
      if (cooldownStatus) {
        if (cooldownRemaining.gt(0)) {
          const hours = Math.floor(cooldownRemaining.toNumber() / 3600);
          const minutes = Math.floor((cooldownRemaining.toNumber() % 3600) / 60);
          cooldownStatus.textContent = `${hours}h ${minutes}m`;
          cooldownStatus.style.color = 'var(--color-warn)';
        } else {
          cooldownStatus.textContent = 'Ready';
          cooldownStatus.style.color = 'var(--color-success)';
        }
      }

      // months passed & progress
      if(vStarted && vestingStartTimeSec > 0){
        const now = Math.floor(Date.now()/1000);
        let months = Math.floor((now - vestingStartTimeSec) / (30*24*60*60));
        if(months < 0) months = 0; 
        if(months > 12) months = 12;
        if (monthsPassedEl) monthsPassedEl.textContent = `${months} / 12`;
        if (progressBar) progressBar.style.width = `${(months/12)*100}%`;
        const nextSec = vestingStartTimeSec + (months+1)*30*24*60*60;
        nextVestingTimeMs = nextSec * 1000;
      } else {
        if (monthsPassedEl) monthsPassedEl.textContent = `0 / 12`;
        if (progressBar) progressBar.style.width = `0%`;
        nextVestingTimeMs = null;
      }

      // claim button enable
      if (claimBtn) {
        const canClaim = await contract.canClaim(account);
        if(canClaim && claimable.gt(0)) { 
          claimBtn.disabled = false; 
        } else { 
          claimBtn.disabled = true; 
        }
      }

      // owner checks
      const ownerAddr = await contract.owner().catch(()=>null);
      isOwner = ownerAddr && ownerAddr.toLowerCase() === account.toLowerCase();
      if (adminBtnSmall) adminBtnSmall.style.display = isOwner ? 'inline-block' : 'none';
      if (openAdmin) openAdmin.style.display = isOwner ? 'inline-block' : 'none';
      if (disconnectBtn) disconnectBtn.style.display = 'inline-block';

      // Load admin data
      if (isOwner) {
        if (adminContractBalance) adminContractBalance.textContent = `${formatTokenAmount(contractBal, decimals)} NUUR`;
        await loadPendingOperations();
      }

    } catch (e){
      console.error('loadAll', e);
      toastShow('Failed to load on-chain data', 'error');
    }
  }

  async function takeSnapshot(){
    if(!contract || !account) return;
    try {
      toastShow('Taking snapshot...');
      if (takeSnapshotBtn) {
        takeSnapshotBtn.disabled = true;
        takeSnapshotBtn.textContent = 'Processing...';
      }
      const tx = await contract.takeSnapshot();
      const receipt = await tx.wait();
      toastShow('Snapshot taken successfully', 'success', EXPLORER ? `${EXPLORER}/tx/${receipt.transactionHash}` : null);
      await loadAll();
      if (takeSnapshotBtn) takeSnapshotBtn.textContent = 'Take Snapshot';
    } catch (e){
      console.error('takeSnapshot', e);
      toastShow('Snapshot failed', 'error');
      if (takeSnapshotBtn) {
        takeSnapshotBtn.disabled = false;
        takeSnapshotBtn.textContent = 'Take Snapshot';
      }
    }
  }

  async function claimTokens(){
    if(!contract || !account) return;
    try {
      const minAmount = minAmountInput.value ? ethers.utils.parseUnits(minAmountInput.value, decimals) : 0;
      
      toastShow('Submitting claim tx...');
      if (claimBtn) {
        claimBtn.disabled = true;
        claimBtn.textContent = 'Processing...';
      }
      const tx = await contract.claim(minAmount);
      const receipt = await tx.wait();
      toastShow('Claim successful', 'success', EXPLORER ? `${EXPLORER}/tx/${receipt.transactionHash}` : null);
      await loadAll();
      if (claimBtn) claimBtn.textContent = 'Claim';
    } catch (e){
      console.error('claim', e);
      toastShow('Claim failed', 'error');
      if (claimBtn) {
        claimBtn.disabled = false;
        claimBtn.textContent = 'Claim';
      }
    }
  }

  /* ---------- Admin handlers ---------- */
  async function openAdminModal(){
    if(!isOwner){ toastShow('Owner required', 'error'); return; }
    adminModal.classList.add('show'); adminModal.setAttribute('aria-hidden','false');
    await loadAll();
  }
  
  function closeAdminModal(){ adminModal.classList.remove('show'); adminModal.setAttribute('aria-hidden','true'); }

  async function loadPendingOperations() {
    if (!isOwner) return;
    
    try {
      const [kycBatch, thresholdUpdate] = await Promise.all([
        contract.getPendingKYCBatch(),
        contract.getPendingWhaleThresholdUpdate()
      ]);

      let pendingHtml = '';
      
      if (kycBatch.canExecute) {
        pendingHtml += `
          <div style="background: var(--color-success); color: white; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
            <strong>KYC Batch Ready</strong> - ${kycBatch.users.length} addresses
            <button onclick="executeKYCBatch()" class="btn btn-ghost" style="margin-left: 8px; background: white; color: var(--color-success);">Execute</button>
          </div>
        `;
      } else if (kycBatch.scheduledTime > 0 && !kycBatch.executed) {
        const timeLeft = kycBatch.scheduledTime - Math.floor(Date.now()/1000);
        const hours = Math.floor(timeLeft / 3600);
        pendingHtml += `
          <div style="background: var(--color-warn); color: white; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
            <strong>KYC Batch Pending</strong> - ${hours}h remaining
          </div>
        `;
      }

      if (thresholdUpdate.canExecute) {
        pendingHtml += `
          <div style="background: var(--color-success); color: white; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
            <strong>Threshold Update Ready</strong> - New: ${formatTokenAmount(thresholdUpdate.newThreshold, decimals)} NUUR
            <button onclick="executeThresholdUpdate()" class="btn btn-ghost" style="margin-left: 8px; background: white; color: var(--color-success);">Execute</button>
          </div>
        `;
      } else if (thresholdUpdate.scheduledTime > 0 && !thresholdUpdate.executed) {
        const timeLeft = thresholdUpdate.scheduledTime - Math.floor(Date.now()/1000);
        const hours = Math.floor(timeLeft / 3600);
        pendingHtml += `
          <div style="background: var(--color-warn); color: white; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
            <strong>Threshold Update Pending</strong> - ${hours}h remaining
          </div>
        `;
      }

      if (!pendingHtml) {
        pendingHtml = '<div class="muted small">No pending operations</div>';
      }

      pendingOperations.innerHTML = pendingHtml;

    } catch (e) {
      console.error('loadPendingOperations', e);
    }
  }

  async function executeKYCBatch() {
    try {
      const tx = await contract.executeKYCBatchUpdate();
      const receipt = await tx.wait();
      toastShow('KYC batch executed', 'success', EXPLORER ? `${EXPLORER}/tx/${receipt.transactionHash}` : null);
      await loadPendingOperations();
      await loadAll();
    } catch (e) {
      console.error('executeKYCBatch', e);
      toastShow('Failed to execute KYC batch', 'error');
    }
  }

  async function executeThresholdUpdate() {
    try {
      const tx = await contract.executeWhaleThresholdUpdate();
      const receipt = await tx.wait();
      toastShow('Threshold update executed', 'success', EXPLORER ? `${EXPLORER}/tx/${receipt.transactionHash}` : null);
      await loadPendingOperations();
      await loadAll();
    } catch (e) {
      console.error('executeThresholdUpdate', e);
      toastShow('Failed to execute threshold update', 'error');
    }
  }

  async function adminSetKycSingle(){
    const a = adminKycAddr.value.trim(); 
    const s = adminKycStatus.value === 'true';
    if(!a){ toastShow('Enter address','error'); return; }
    try {
      const tx = await contract.setKYC(a, s);
      const r = await tx.wait();
      toastShow('KYC updated', 'success', EXPLORER ? `${EXPLORER}/tx/${r.transactionHash}` : null);
      adminKycAddr.value = '';
      if(a.toLowerCase() === account.toLowerCase()) await loadAll();
    } catch(e){ console.error(e); toastShow('Failed to set KYC', 'error'); }
  }

  async function adminScheduleKycBatchHandler(){
    const rawAddrs = adminKycBatchAddrs.value.trim();
    const status = adminKycBatchStatus.value === 'true';
    if(!rawAddrs){ toastShow('Provide addresses','error'); return; }
    const addrs = rawAddrs.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
    if(addrs.length === 0){ toastShow('No valid addresses','error'); return; }
    if(!confirm(`Schedule KYC ${status ? 'verification' : 'revocation'} for ${addrs.length} addresses?`)) return;
    try {
      const tx = await contract.scheduleKYCBatchUpdate(addrs, status);
      const r = await tx.wait();
      toastShow('KYC batch scheduled', 'success', EXPLORER ? `${EXPLORER}/tx/${r.transactionHash}` : null);
      adminKycBatchAddrs.value='';
      await loadPendingOperations();
    } catch(e){ console.error(e); toastShow('Failed to schedule KYC batch', 'error'); }
  }

  async function adminScheduleThresholdHandler(){
    const newThreshold = newWhaleThreshold.value.trim();
    if(!newThreshold){ toastShow('Enter new threshold','error'); return; }
    try {
      const thresholdWei = ethers.utils.parseUnits(newThreshold, decimals);
      const tx = await contract.scheduleWhaleThresholdUpdate(thresholdWei);
      const r = await tx.wait();
      toastShow('Threshold update scheduled', 'success', EXPLORER ? `${EXPLORER}/tx/${r.transactionHash}` : null);
      newWhaleThreshold.value = '';
      await loadPendingOperations();
    } catch(e){ console.error(e); toastShow('Failed to schedule threshold update', 'error'); }
  }

  async function adminDepositFunds(){
    const amount = depositAmount.value.trim();
    if(!amount){ toastShow('Enter amount','error'); return; }
    try {
      const amountWei = ethers.utils.parseUnits(amount, decimals);
      toastShow('Depositing funds...');
      const tx = await contract.depositFunds(amountWei);
      const r = await tx.wait();
      toastShow('Funds deposited', 'success', EXPLORER ? `${EXPLORER}/tx/${r.transactionHash}` : null);
      depositAmount.value = '';
      await loadAll();
    } catch(e){ console.error(e); toastShow('Deposit failed', 'error'); }
  }

  async function adminStartVesting(){ 
    if(!confirm('Start vesting? This is irreversible.')) return; 
    try{ 
      const tx = await contract.startVesting(); 
      const r = await tx.wait(); 
      toastShow('Vesting started','success', EXPLORER ? `${EXPLORER}/tx/${r.transactionHash}` : null); 
      await loadAll(); 
    } catch(e){ console.error(e); toastShow('Failed to start','error'); } 
  }
  
  async function adminPauseHandler(){ 
    if(!confirm('Pause contract?')) return; 
    try{ 
      const tx = await contract.pause(); 
      const r = await tx.wait(); 
      toastShow('Paused','success', EXPLORER ? `${EXPLORER}/tx/${r.transactionHash}` : null); 
      await loadAll(); 
    } catch(e){ console.error(e); toastShow('Failed to pause','error'); } 
  }
  
  async function adminUnpauseHandler(){ 
    if(!confirm('Unpause contract?')) return; 
    try{ 
      const tx = await contract.unpause(); 
      const r = await tx.wait(); 
      toastShow('Unpaused','success', EXPLORER ? `${EXPLORER}/tx/${r.transactionHash}` : null); 
      await loadAll(); 
    } catch(e){ console.error(e); toastShow('Failed to unpause','error'); } 
  }

  /* ---------------- Polling & countdown ---------------- */
  let pollHandle = null;
  function startPoll(){ if(pollHandle) clearInterval(pollHandle); pollHandle = setInterval(pollTick, POLL_INTERVAL); }
  async function pollTick(){
    try {
      if(!contract || !account) return;
      const claimable = await contract.getClaimableAmount(account);
      if(claimable.gt(lastClaimable)){
        toastShow('New tokens unlocked ‚Äî claim available', 'success');
        lastClaimable = claimable;
        await loadAll();
      }
      if(nextVestingTimeMs && Date.now() >= nextVestingTimeMs){ await loadAll(); }
    } catch(e){ console.error('pollTick', e); }
  }

  function startCountdown(){
    setInterval(()=>{
      if(!nextVestingTimeMs){ 
        if(cdDays) cdDays.textContent='--'; 
        if(cdHours) cdHours.textContent='--'; 
        if(cdMins) cdMins.textContent='--'; 
        if(cdSecs) cdSecs.textContent='--'; 
        return; 
      }
      const diff = Math.max(0, nextVestingTimeMs - Date.now());
      if(diff <= 0){ 
        if(cdDays) cdDays.textContent='00'; 
        if(cdHours) cdHours.textContent='00'; 
        if(cdMins) cdMins.textContent='00'; 
        if(cdSecs) cdSecs.textContent='00'; 
        return; 
      }
      const days = Math.floor(diff/(1000*60*60*24));
      const hours = Math.floor((diff%(1000*60*60*24))/(1000*60*60));
      const mins = Math.floor((diff%(1000*60*60))/(1000*60));
      const secs = Math.floor((diff%(1000*60))/1000);
      if(cdDays) cdDays.textContent = String(days).padStart(2,'0');
      if(cdHours) cdHours.textContent = String(hours).padStart(2,'0');
      if(cdMins) cdMins.textContent = String(mins).padStart(2,'0');
      if(cdSecs) cdSecs.textContent = String(secs).padStart(2,'0');
    }, 1000);
  }

  /* -------------- UI wiring -------------- */
  if (connectBtn) connectBtn.addEventListener('click', connectWallet);
  if (disconnectBtn) disconnectBtn.addEventListener('click', disconnectWallet);
  if (takeSnapshotBtn) takeSnapshotBtn.addEventListener('click', takeSnapshot);
  if (claimBtn) claimBtn.addEventListener('click', claimTokens);
  if (refreshBtnSmall) refreshBtnSmall.addEventListener('click', loadAll);
  if (refreshBtnLarge) refreshBtnLarge.addEventListener('click', loadAll);

  if (adminBtnSmall) adminBtnSmall.addEventListener('click', openAdminModal);
  if (openAdmin) openAdmin.addEventListener('click', openAdminModal);
  if (closeAdmin) closeAdmin.addEventListener('click', closeAdminModal);
  if (adminSetKyc) adminSetKyc.addEventListener('click', adminSetKycSingle);
  if (adminScheduleKycBatch) adminScheduleKycBatch.addEventListener('click', adminScheduleKycBatchHandler);
  if (adminScheduleThreshold) adminScheduleThreshold.addEventListener('click', adminScheduleThresholdHandler);
  if (adminDeposit) adminDeposit.addEventListener('click', adminDepositFunds);
  if (adminStart) adminStart.addEventListener('click', adminStartVesting);
  if (adminPause) adminPause.addEventListener('click', adminPauseHandler);
  if (adminUnpause) adminUnpause.addEventListener('click', adminUnpauseHandler);

  if (contractLink) {
    contractLink.addEventListener('click', (e)=> {
      if(!EXPLORER){ e.preventDefault(); navigator.clipboard && navigator.clipboard.writeText(CONTRACT_ADDR).then(()=> toastShow('Contract address copied','success')); }
    });
  }

  // Initialize
  applyStoredTheme();
  startCountdown();

  // Expose functions for global access
  window.executeKYCBatch = executeKYCBatch;
  window.executeThresholdUpdate = executeThresholdUpdate;
  window.__nuur = { loadAll };

})();
</script>
</body>
</html>
